<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deepfake Detection Test Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            min-height: 100vh;
        }
        
        .container {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
        }
        
        .status {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }
        
        .status.connected {
            background: rgba(76, 175, 80, 0.3);
            border: 2px solid #4CAF50;
        }
        
        .status.disconnected {
            background: rgba(244, 67, 54, 0.3);
            border: 2px solid #f44336;
        }
        
        .upload-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .file-input-wrapper {
            position: relative;
            display: inline-block;
            margin: 10px;
        }
        
        .file-input {
            display: none;
        }
        
        .file-input-label {
            display: inline-block;
            padding: 12px 24px;
            background: #4CAF50;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.3s;
        }
        
        .file-input-label:hover {
            background: #45a049;
        }
        
        .record-button {
            padding: 15px 30px;
            font-size: 18px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px;
            transition: background 0.3s;
        }
        
        .record-button:hover {
            background: #1976D2;
        }
        
        .record-button.recording {
            background: #f44336;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.7; }
            100% { opacity: 1; }
        }
        
        .result {
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .result.real {
            background: rgba(76, 175, 80, 0.3);
            border-left: 5px solid #4CAF50;
        }
        
        .result.fake {
            background: rgba(244, 67, 54, 0.3);
            border-left: 5px solid #f44336;
        }
        
        .result.error {
            background: rgba(255, 152, 0, 0.3);
            border-left: 5px solid #FF9800;
        }
        
        .log {
            background: rgba(0,0,0,0.3);
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .demo-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
        }
        
        .demo-button {
            padding: 10px 20px;
            background: #FF9800;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üõ°Ô∏è Deepfake Detection Test Client</h1>
        
        <div id="status" class="status disconnected">
            üîå Disconnected
        </div>
        
        <div class="upload-section">
            <h3>üì§ Upload Audio File</h3>
            <div class="file-input-wrapper">
                <input type="file" id="audioFile" class="file-input" accept=".wav,.mp3,.m4a,.flac">
                <label for="audioFile" class="file-input-label">Choose Audio File</label>
            </div>
            <p>Supported formats: WAV, MP3, M4A, FLAC</p>
        </div>
        
        <div class="upload-section">
            <h3>üé§ Record Audio</h3>
            <button id="recordButton" class="record-button">Start Recording</button>
            <p id="recordingStatus"></p>
        </div>
        
        <div class="demo-section">
            <h3>üß™ Test with Demo Data</h3>
            <p>No audio file? Test with synthetic audio data:</p>
            <button class="demo-button" onclick="sendDemoReal()">üì¢ Test "Real" Audio</button>
            <button class="demo-button" onclick="sendDemoFake()">ü§ñ Test "Fake" Audio</button>
        </div>
        
        <div id="result"></div>
        
        <div class="log" id="log"></div>
    </div>

    <script>
        // WebSocket connection
        const socket = io('http://localhost:5000');
        const statusDiv = document.getElementById('status');
        const resultDiv = document.getElementById('result');
        const logDiv = document.getElementById('log');
        
        let isRecording = false;
        let mediaRecorder = null;
        let audioChunks = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        // Socket events
        socket.on('connect', () => {
            statusDiv.innerHTML = '‚úÖ Connected to Deepfake Detection Server';
            statusDiv.className = 'status connected';
            log('Connected to WebSocket server');
        });
        
        socket.on('disconnect', () => {
            statusDiv.innerHTML = 'üîå Disconnected';
            statusDiv.className = 'status disconnected';
            log('Disconnected from server');
        });
        
        socket.on('status', (data) => {
            log(`Server status: ${data.message}`);
            if (data.model_loaded) {
                log('‚úÖ Model is loaded and ready');
            } else {
                log('‚ö†Ô∏è Model not loaded on server');
            }
        });
        
        socket.on('detection_result', (data) => {
            displayResult(data);
        });
        
        function displayResult(data) {
            if (data.success) {
                const resultClass = data.is_deepfake ? 'fake' : 'real';
                const icon = data.is_deepfake ? 'üö´' : '‚úÖ';
                const label = data.is_deepfake ? 'DEEPFAKE DETECTED' : 'APPEARS REAL';
                
                resultDiv.innerHTML = `
                    <div class="result ${resultClass}">
                        <h3>${icon} ${label}</h3>
                        <p><strong>Confidence:</strong> ${data.confidence_score}%</p>
                        <p><strong>Real Probability:</strong> ${data.real_probability}%</p>
                        <p><strong>Fake Probability:</strong> ${data.fake_probability}%</p>
                        <p><strong>Processing Time:</strong> ${data.processing_time_ms}ms</p>
                        <p><strong>Audio Duration:</strong> ${data.audio_duration_seconds}s</p>
                        <p><em>${data.message}</em></p>
                    </div>
                `;
                
                log(`Result: ${label} (${data.confidence_score}% confidence)`);
            } else {
                resultDiv.innerHTML = `
                    <div class="result error">
                        <h3>‚ùå Error</h3>
                        <p>${data.error}</p>
                    </div>
                `;
                log(`Error: ${data.error}`);
            }
        }
        
        // File upload handling
        document.getElementById('audioFile').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (file) {
                log(`Selected file: ${file.name} (${file.size} bytes)`);
                processAudioFile(file);
            }
        });
        
        function processAudioFile(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const base64Audio = e.target.result;
                log('Sending audio to server for detection...');
                socket.emit('detect_audio', { audio: base64Audio });
            };
            reader.readAsDataURL(file);
        }
        
        // Recording functionality
        document.getElementById('recordButton').addEventListener('click', toggleRecording);
        
        async function toggleRecording() {
            if (!isRecording) {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    audioChunks = [];
                    
                    mediaRecorder.ondataavailable = (event) => {
                        audioChunks.push(event.data);
                    };
                    
                    mediaRecorder.onstop = () => {
                        const audioBlob = new Blob(audioChunks, { type: 'audio/wav' });
                        processAudioFile(audioBlob);
                    };
                    
                    mediaRecorder.start();
                    isRecording = true;
                    document.getElementById('recordButton').textContent = 'Stop Recording';
                    document.getElementById('recordButton').className = 'record-button recording';
                    document.getElementById('recordingStatus').textContent = 'üî¥ Recording...';
                    log('Started recording audio');
                    
                } catch (error) {
                    log(`Microphone error: ${error.message}`);
                    alert('Could not access microphone. Please check permissions.');
                }
            } else {
                mediaRecorder.stop();
                mediaRecorder.stream.getTracks().forEach(track => track.stop());
                isRecording = false;
                document.getElementById('recordButton').textContent = 'Start Recording';
                document.getElementById('recordButton').className = 'record-button';
                document.getElementById('recordingStatus').textContent = '';
                log('Stopped recording');
            }
        }
        
        // Demo functions
        function sendDemoReal() {
            log('Sending demo "real" audio data...');
            // Create a simple sine wave as demo audio
            const demoAudio = generateDemoAudio(440, 2); // 440Hz for 2 seconds
            socket.emit('detect_audio', { audio: demoAudio });
        }
        
        function sendDemoFake() {
            log('Sending demo "fake" audio data...');
            // Create a different pattern for "fake" demo
            const demoAudio = generateDemoAudio(880, 2); // 880Hz for 2 seconds
            socket.emit('detect_audio', { audio: demoAudio });
        }
        
        function generateDemoAudio(frequency, duration) {
            // Generate a simple sine wave as demo audio
            const sampleRate = 22050;
            const numSamples = sampleRate * duration;
            const audioData = new Float32Array(numSamples);
            
            for (let i = 0; i < numSamples; i++) {
                audioData[i] = Math.sin(2 * Math.PI * frequency * i / sampleRate);
            }
            
            // Convert to WAV format and base64
            const wavBuffer = encodeWAV(audioData, sampleRate);
            return 'data:audio/wav;base64,' + arrayBufferToBase64(wavBuffer);
        }
        
        function encodeWAV(audioData, sampleRate) {
            const length = audioData.length;
            const buffer = new ArrayBuffer(44 + length * 2);
            const view = new DataView(buffer);
            
            // WAV header
            const writeString = (offset, string) => {
                for (let i = 0; i < string.length; i++) {
                    view.setUint8(offset + i, string.charCodeAt(i));
                }
            };
            
            writeString(0, 'RIFF');
            view.setUint32(4, 36 + length * 2, true);
            writeString(8, 'WAVE');
            writeString(12, 'fmt ');
            view.setUint32(16, 16, true);
            view.setUint16(20, 1, true);
            view.setUint16(22, 1, true);
            view.setUint32(24, sampleRate, true);
            view.setUint32(28, sampleRate * 2, true);
            view.setUint16(32, 2, true);
            view.setUint16(34, 16, true);
            writeString(36, 'data');
            view.setUint32(40, length * 2, true);
            
            // Audio data
            let offset = 44;
            for (let i = 0; i < length; i++) {
                view.setInt16(offset, audioData[i] * 0x7FFF, true);
                offset += 2;
            }
            
            return buffer;
        }
        
        function arrayBufferToBase64(buffer) {
            let binary = '';
            const bytes = new Uint8Array(buffer);
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary);
        }
        
        log('Test client loaded. Connect to server and test your deepfake detection!');
    </script>
</body>
</html>